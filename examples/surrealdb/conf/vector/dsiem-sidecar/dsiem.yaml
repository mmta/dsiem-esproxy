# this config file is used to send dsiem-backend logs to surrealdb and to dsiem-esproxy
# - siem_alarm_events.json will be sent directly to surrealdb
# - siem_alarms.json will be sent to dsiem-esproxy so that it can insert new alarms
#   or update existing ones in surrealdb

sources:
  dsiem_alarm_events:
    type: "file"
    include:
      - "/var/log/dsiem/siem_alarm_events.json"
  dsiem_alarms:
    type: "file"
    include:
      - "/var/log/dsiem/siem_alarms.json"

transforms:
  transform_dsiem_alarm_events:
    type: remap
    inputs:
      - dsiem_alarm_events
    drop_on_abort: true
    drop_on_error: true
    
    # this creates surrealdb record link between the alarm and the event in alarm_event
    source: |-
      . = parse_json!(.message)
      .alarm = "alarm:" + string!(.alarm_id)
      .event = "event:⟨" + string!(.event_id) + "⟩"
      del(.alarm_id)
      del(.event_id)

  transform_dsiem_alarms:
    type: remap
    inputs:
      - dsiem_alarms
    drop_on_abort: true
    drop_on_error: true

    # here the format is already aligned with what dsiem-esproxy expects
    source: |-
      . = parse_json!(.message)
