# this is a sample config file that demonstrates how to lookup plugin_id and plugin_sid
# from a TSV file generated by dpluger.

# If the TSV file is mounted from dsiem-tools pod, then updates made by auto-directive
# will automatically be applied to Vector without needing to restart any pod.

sources:
  random_netdevice:
    type: demo_logs
    format: syslog

enrichment_tables:
  random_netdevice:
    type: "file"
    file:
      path: "/etc/vector/random_netdevice.tsv"
      encoding:
        type: "csv"
        delimiter: "\t"
    schema:
      plugin: "string"
      id: "integer"
      sid: "integer"
      title: "string"

transforms:
  transform_random_netdevice:
    type: remap
    inputs:
      - random_netdevice
    drop_on_abort: true
    drop_on_error: true
    source: |-
      . = parse_syslog!(.message)
      temp = .hostname
      .index_name = "random_netdevice"
      .@timestamp = now()
      .host = temp
      
  norm_event_random_netdevice:
    type: remap
    inputs:
      - transform_random_netdevice
    drop_on_abort: true
    drop_on_error: true
    
    # to automatically remove unused fields, first we set the fields we want to keep
    # in the .norm_event object. Then later on when all fields are collected, we set
    # the root object to .norm_event, which will remove all other unused fields.
    # this is a better method than using del().

    # the most important thing below is the lookup of plugin_id and plugin_sid from the
    # enrichment table. This is done by calling get_enrichment_table_record() function.
    # If the record is not found, the transform will abort and the event will be dropped.

    # notice several fields below are hard-coded because the demo log generator doesn't
    # supply them. In actual case we would get them from the log source.

    source: |-
      .norm_event.sensor = .host
      .norm_event.timestamp = .timestamp
      .norm_event.@timestamp = .@timestamp
      .norm_event.src_ip = "0.0.0.0"
      .norm_event.dst_ip = "192.168.0.1"
      .norm_event.src_port = 0
      .norm_event.dst_port = 0
      .norm_event.protocol = "TCP/IP"
      .norm_event.product = "Network Device"
      .norm_event.category = "Router"

      row, err = get_enrichment_table_record("random_netdevice", { "title":  .appname })
      if err != null {
        abort
      }
      .norm_event.plugin_id = row.id
      .norm_event.plugin_sid = row.sid
      .norm_event.title, err = "Random device event: " + row.title
      if err != null {
        log("Unable to set title: " + err, level: "error")
        abort
      }

      . = .norm_event
      .index_name = "siem_events"
      .event_id = uuid_v4()


